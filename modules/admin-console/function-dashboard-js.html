<script src="../assets/js/jquery.timer.js"></script>
<script>
	$("#navigation").html("大盘监控");
	//重置右上Select区域(Total,Rtt,Failed)
	$("#nav-search").empty();
	$("#nav-search").append("<select id=\"search\" style=\"width:200px;\"><option value=\"total\">访问总量</option><option value=\"failed\">错误总量</option><option value=\"rtt\">平均耗时</option></select>");
	//当前监控类型
	var current = "total";
	//模板
	var template = "<tr id=\"#{id}\"><td>#{service}</td><td>#{version}</td><td class=\"red\">#{current}</td><td>#{compare}</td></tr>";
	
	//period=偏移量
	function failed(period){
		jQuery.ajax({
			type : "GET",
			url : "/api/dashboard/failed?adjust=" + period,
			success : function callback(data) {
				loading($("#period"), data);
			}
		});
	}
	
	//period=偏移量
	function total(period){
		jQuery.ajax({
			type : "GET",
			url : "/api/dashboard/total?adjust=" + period,
			success : function callback(data) {
				loading($("#period"), data);
			}
		});
	}
	
	//period=偏移量
	function rtt(period){
		jQuery.ajax({
			type : "GET",
			url : "/api/dashboard/rtt?adjust=" + period,
			success : function callback(data) {
				loading($("#period"), data);
			}
		});
	}
	
	function loading(container, data) {
		//重置列表
		container.empty();
		$(data).each(function(index, element){
			//追加服务数值
			container.append(template.replace("#{id}", index).replace("#{service}", element.service.service).replace("#{version}", element.service.versionAndCatalog).replace("#{current}", element.period).replace("#{compare}", element.compare + "%"));
			$("#" + index).click(function(){
				window.location.href = "?function=function-chart&service=" + element.service.service + "&versionAndCatalog=" + element.service.versionAndCatalog;
			})
		});
	}
	
	$("#search").change(function(){
		//更换监控类型并刷新
		current = $("#search").find('option:selected').val();
		refresh();
	})
	 
	function refresh(){
			switch(current){
			case "rtt":
				flush4rtt();
				break;
			case "total":
				flush4total();
				break;
			case "failed":
				flush4failed();
				break;
		 }
	}
	 
	function flush4total(){
		total(0);
	}
			
	function flush4failed(){
		failed(0);
	}
	 
	function flush4rtt(){
		rtt(0);
	}

	$(document).ready(function() {
		refresh();
		var timer = $.timer(20000, refresh);
	});
</script>
